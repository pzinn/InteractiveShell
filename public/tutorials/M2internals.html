<title> Notes for M2internals 26/09/2020</title>
<div><h2> Overview of <b>Macaulay2Web</b></h2>
  <p><b>Macaulay2Web</b> is a fork of <b>InteractiveShell</b> whose goal is to provide a semi-graphical web interface for Macaulay2.
  </p>
  <p>It is available on Github and you're all welcome to download it / contribute to it.
  </p>
  <p>It is currently running on the Melbourne Research Cloud (server running Ubuntu + NodeJS HTTPS server,
    dockers running Fedora + Macaulay2).
  </p>
  <p>There was a peak of 2000 "users" at launch, has now stabilized to about 200 users
    (maximum simultaneous users: 384).
  </p>
  <p>For some features, see the <a target="_self" href="#tutorial-4">interface tutorial</a>.
  </p>
</div>
<div><h2> The <tt>WebApp</tt> mode</h2>
  <p>At the level of Macaulay2, the way Macaulay2Web works is through the mechanism of alternative output modes governed by the global variable
    <tt>topLevelMode</tt>:
  </p>
  <p><code>help "topLevelMode"</code></p>
  <p>If you revert to
  </p>
  <p><code>topLevelMode=Standard</code></p>
  <p>then the interface will behave more or less like the original InteractiveShell.
    Let's go back to
  </p>
  <p><code>topLevelMode=WebApp</code></p>
  <p>Internally, each type has some routines that determine the output of that class in the given mode:
  </p>
  <p><code>select(keys Thing,x -> class x === List)</code></p>
  <p><tt>Print</tt> is the most important one: compare
  </p>
  <p><code>code Thing#{Standard,Print}</code></p>
  <p>and
  </p>
  <p><code>code Thing#{WebApp,Print}</code></p>
  <p>Two things to notice for now:
    <ul>
      <li> The output is HTML (with embedded TeX).</li>
      <li> The interaction with the browser is controlled by "tags".</li>
    </ul>
  </p>
</div>
<div><h2> Mode agnosticism</h2>
  <p>Example: pre 2018, <tt>describe</tt> returned a <tt>Net</tt>:
<pre style="background:white; overflow-x:scroll">
Macaulay2, version 1.10.0.1
with packages: ConwayPolynomials, Elimination, IntegralClosure, InverseSystems, LLLBases, MinimalPrimes, PrimaryDecomposition, ReesAlgebra, TangentCone, Truncations

i1 : R=QQ[x]; describe R

o1 = QQ[x, Degrees => {1}, Heft => {1}, MonomialOrder => {MonomialSize => 32}, DegreeRank => 1]
                                                         {GRevLex => {1}    }
                                                         {Position => Up    }
i2 : class oo

o2 = Net

o2 : Type
</pre>
which meant that no matter what the output mode, <tt>describe</tt>'s actual output would look like the above.
  </p>
  <p>One way to resolve these issues is via <b>expressions</b> (more on that later):
  </p>
  <p><code>R=QQ[x]; describe R</code></p>
  <p><code>ancestors class oo</code></p>
</div>
<div><h2> Control sequences</h2>
  <p>Because the output of Macaulay2 is a mixture of plain text (at least for now...), HTML and LaTeX, the browser needs some extra information to tell which is which.
    This is provided by tags: (to be only used internally!)
  </p>
  <p><code>get "!head -n14 /usr/share/Macaulay2/Core/webapp.m2"</code></p>
  <p>Here's how they work:
  </p>
  <p><code>debug Core; s=webAppHtmlTag | "&lt;h1&gt;TEST&lt;/h1&gt;" | webAppEndTag</code></p>
  <p>Nice try, but the WebApp mode filters tags to make sure you don't mess with the browser's formatting.
    <!-- actually in this case the htmlLiteral would prevent it anyway -->
    <code>print s</code>
    wouldn't work either.
    One must resort to low-level output:
  </p>
  <p><code><< s</code></p>
  <p><code><< webAppUrlTag | "https://blogs.unimelb.edu.au/paul-zinn-justin/" | webAppEndTag</code></p>
  <p><code><< endl << webAppTexTag | "\\bigoplus_{i=1}^n V^{\\otimes i}" | webAppTexEndTag << endl</code></p>
</div>
<div><h2> HTML vs (La)TeX</h2>
  <p>Only <i>math</i> is typeset in (La)TeX (this is also the spirit of KaTeX).
    See also the recent discussion on documentation and KaTeX.
  </p>
  <p>$\Rightarrow$ We use HTML for nonmath (e.g., strings & nets), (La)TeX for math. 
    This is determined by the method <tt>html</tt>. By default,<br/>
    <tt>html Thing := tex</tt><br/>
    (or something approaching);
    whereas e.g. <br/><tt>html Hypertext</tt> is redefined to produce HTML output.
  </p>
  <p><i>Good place for a break</i>
  </p>
  <p>Suggested "exercises":
    <ul>
      <li> Pick you favorite short M2 code, load it in the editor, run it either line by line or by selecting all and then pressing evaluate.<br/>
	Does it run? If not, let me know!
      <li> Create a new <tt>Type</tt>, define a fun <tt>texMath</tt> function for it, create an object of this type to see if the output is what you intended.
    </ul>
  </p>
</div>
<div><h2> Expressions</h2>
  <p><i>Expressions</i> are an intermediate layer between mathematical objects (or other Macaulay2 objects) and their output to the screen:
  </p>
  <p><code>viewHelp Expression</code></p>
  <p>$\Big[$insert rant about <tt>factor</tt> not producing a proper Expression: try <code>factor(x^2)</code> or worse <code>factor(3*x^2)</code>, comparing with <code>expression(x^2)</code> or
    <code>expression(3*x^2)</code>$\big]$
  </p>
  <p>As mentioned before, they are also a useful tool for output mode agnosticism: see <a target="_self" href="#tutorial-4-2">interface tutorial</a>.</p>
  <p>Note that pre 2018, not all expressions existed, and even when they did, they were not always used by the output routines.
  </p>
  <p>There is now a consistent logic for <tt>expression</tt> methods, with a proper Expression following a simple tree structure. Types fall into two categories:
    <ul>
      <li> Types whose <tt>expression</tt> is a <tt>Holder</tt> of themselves (<tt>expression</tt> is "turned off"); <!-- or of their symbols... -->
	then these types <i>must</i> have output routines <tt>toString</tt>/<tt>net</tt>/<tt>texMath</tt>/<tt>html</tt>/etc.
	These objects are considered "elementary" -- they cannot be broken down further; they&apos;re the leaves of the tree.<br/>
	<code>code(expression,BettiTally)</code></li>
      <li> Types which have an actual <tt>expression</tt> (and no output routines).
	These types are the nodes of the tree; typically, their <tt>expression</tt> acts recursively.<br/>
	<code>code(expression,MutableMatrix)</code></li>
    </ul>
  </p>
  <p>[switch to <code>debugLevel=42</code> to show expression structure]
  </p>
</div>
<div><h2> The pitfalls of expressionifying</h2>
  <p>In the current version of Macaulay2, expressions are "turned off" for <tt>BasicList</tt> and <tt>HashTable</tt>. The reason I did not expressionify these types is
    that most user-defined types are descendants of those and it might confuse users (and create backward compatibility issues with existing packages).
    
  <p>On the branch <tt>refactor/expression</tt>, expressions are now by default turned on for many more types including the two above. Let us take an example to see what the problem is.
    Say you define a new type
  </p>
  <p><code>MyType = new Type of BasicList</code></p>
  <p>Traditionally you would directly define output routines such as <tt>net</tt> (for <tt>Standard</tt> output) or <tt>texMath</tt> (for <tt>WebApp</tt> output).
    Here we do both so this tutorial works in both modes:
  </p>
  <p><code>net MyType := x -> net x#0 | " |- " | net x#1;
texMath MyType := x -> texMath x#0 | "\\vdash " | texMath x#1;
</code>
</p>
<p>Then you would create a new object, and everything looks okay:
</p>
<p><code>X = new MyType from {a,b}</code></p>
<p>but now you use <tt>X</tt> somewhere, say
</p>
<p><code>someOption => X</code></p>
<p>and surprise, instead of the expected \( \textit{someOption}\ \Rightarrow\ (a\vdash b)\)
  (which is what you will get with the current version of Macaulay2, in particular if you run it on the cloud),
  on the <tt>refactor/expression</tt> branch it says \( \textit{someOption}\ \Rightarrow\ \texttt{MyType}\{a,\,b\} \).
</p>
  <p>Why? because <tt>expression</tt> has not been redefined, so
  </p>
  <p><code>expression X</code></p>
  <p>is inherited from <tt>BasicList</tt>.
  </p>
  <p>Two possible fixes:
    <ol>
      <li>The quick fix: return to the previous situation by deactivating <tt>expression</tt>:
	<code>expression MyType := hold</code>
	Now everything works fine.
      </li>
      <li>The better way: switch to using <tt>expression</tt>. Let&apos;s start over:
	<code>MyType = new Type of BasicList</code>
	but this time define only the expression:
	<code>expression MyType := x -&gt; expression x#0 |- expression x#1;</code>
	This will automatically take care of every possible form of output (ascii, tex, html...).
      </li>
    </ol>
  </p>
</div>
<div><h2>Expressions cont&apos;d: <tt>value</tt></h2>
  <p>It is good taste to produce with <tt>expression</tt> an <tt>Expression</tt> on which
    <tt>value</tt> can be run, returning the original object (or at least the closest possible
    approximation to it). By default this will not be the case with the example of the previous page:
  </p>
  <p><code>value expression X</code></p>
  <p>However, this can be easily fixed by adding e.g.
  </p>
  <p><code>Thing |- Thing := (x,y) -> new MyType from {x,y}</code></p>
  <p>Now it will work, and in fact</p>
  <p><code>value expression X === X</code></p>
  <hr/>
  Suggested "exercises":
  <ul>
    <li>Find a type (say, defined in some package) whose output is incorrect in <tt>WebApp</tt> mode and would be amenable to expressionification.
      Try to define its <tt>expression</tt> (and make the output routines use this expression).
    </li>
  </ul>
</div>
<div><h2>Future work</h2>
  <ul>
    <li>Page design (editor textarea stuff, overall html) $\longleftarrow$ <i>help needed!</i></li>
    <li>Interaction between HTML and TeX? Ambiguous role of <tt>Hypertext</tt> types
      (e.g., is it OK to have non HTML inside a Hypertext? should <tt>html</tt> recurse inside them? etc)
      $\longleftarrow$ <i>ongoing discussion with Mahrud</i></li>
    <li>Thread-safety of <tt>webapp.m2</tt> code.</li>
    <li>Tutorial conversion from md to HTML $\longleftarrow$ <i>help needed!</i></li>
    <li>Reusing output as input? (thanks to expressions)</li>
    <li>Atom editor</li>
    <li>Applying these ideas to other modes (what&apos;s this jupyter thing?)</li>
    <li>Plot in VectorGraphics $\longleftarrow$ <i>help needed!</i></li>
  </ul>
</div>
